name: CI

on:
  push:
    branches: [ "master" ]
  pull_request:
    branches: [ "master" ]
  workflow_dispatch:

env:
  CARGO_TERM_COLOR: always

jobs:
  rust:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6

      - uses: dtolnay/rust-toolchain@stable
        with:
          components: rustfmt, clippy

      - uses: Swatinem/rust-cache@v2

      - name: Format (rustfmt)
        run: cargo fmt --all -- --check

      - name: Lint (clippy)
        run: cargo clippy --all-targets --all-features -- -D warnings -D clippy::cognitive_complexity

      - name: Test with timing
        run: cargo test --all-features -- --show-output

      - name: Check for large files
        run: |
          find . -type f -size +1M -not -path "./.git/*" -not -path "./target/*" | head -20 > large_files.txt
          if [ -s large_files.txt ]; then
            echo "Warning: Large files detected (>1MB):"
            cat large_files.txt
          fi

  coverage:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6

      - uses: dtolnay/rust-toolchain@stable

      - uses: Swatinem/rust-cache@v2

      - name: Install cargo-tarpaulin
        run: cargo install cargo-tarpaulin

      - name: Generate coverage
        run: cargo tarpaulin --all-features --out xml --output-dir coverage

      - name: Upload coverage to Codecov
        uses: codecov/codecov-action@v5
        with:
          files: coverage/cobertura.xml
          fail_ci_if_error: false

  security:
    runs-on: ubuntu-latest
    permissions:
      security-events: write
      actions: read
      contents: read
    steps:
      - uses: actions/checkout@v6

      - name: Run Semgrep
        uses: returntocorp/semgrep-action@v1
        with:
          config: >-
            p/rust
            p/security-audit
        continue-on-error: true

  tech-debt:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6

      - name: Scan for TODO/FIXME comments
        run: |
          echo "## Tech Debt Report" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          count=$(grep -rn "TODO\|FIXME\|HACK\|XXX" --include="*.rs" src/ 2>/dev/null | wc -l || echo "0")
          echo "Found **$count** tech debt markers" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          if [ "$count" -gt "0" ]; then
            echo '```' >> $GITHUB_STEP_SUMMARY
            grep -rn "TODO\|FIXME\|HACK\|XXX" --include="*.rs" src/ 2>/dev/null | head -20 >> $GITHUB_STEP_SUMMARY || true
            echo '```' >> $GITHUB_STEP_SUMMARY
          fi

  unused-deps:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: dtolnay/rust-toolchain@nightly

      - uses: Swatinem/rust-cache@v2

      - name: Install cargo-udeps
        run: cargo install cargo-udeps --locked

      - name: Check unused dependencies
        run: cargo +nightly udeps --all-features
        continue-on-error: true

  duplicate-code:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v6
        with:
          node-version: '20'

      - name: Install jscpd
        run: npm install -g jscpd

      - name: Check duplicate code
        run: |
          echo "## Duplicate Code Report" >> $GITHUB_STEP_SUMMARY
          jscpd src/ --min-lines 10 --threshold 5 --reporters markdown >> $GITHUB_STEP_SUMMARY 2>&1 || true

  validate-agents-md:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: dtolnay/rust-toolchain@stable
        with:
          components: rustfmt, clippy

      - uses: Swatinem/rust-cache@v2

      - name: Verify AGENTS.md commands work
        run: |
          echo "## AGENTS.md Validation" >> $GITHUB_STEP_SUMMARY
          echo "Testing documented commands..." >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "✅ cargo build --all-features" >> $GITHUB_STEP_SUMMARY
          cargo build --all-features
          echo "✅ cargo test --all-features (list only)" >> $GITHUB_STEP_SUMMARY
          cargo test --all-features -- --list > /dev/null
          echo "✅ cargo clippy --all-features" >> $GITHUB_STEP_SUMMARY
          cargo clippy --all-features -- -D warnings > /dev/null
          echo "✅ cargo fmt --check" >> $GITHUB_STEP_SUMMARY
          cargo fmt --check
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "All AGENTS.md commands validated successfully!" >> $GITHUB_STEP_SUMMARY
